/** Made by Chadwick Hobgood, 1/26/2025
 * * Creates separate distributions for Start Times (Archive Col A) and End Times (Archive Col W)
 * and outputs results to "Dashboard_Data_Link" Columns J:L.
 */
function Request_and_Completion_Distribution() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  
  // Define Sheets
  const archiveSheet = ss.getSheetByName("Archive");
  const dashboardSheet = ss.getSheetByName("Dashboard_Data_Link");
  
  const lastRow = archiveSheet.getLastRow();
  if (lastRow < 2) return; 

  // 1. Get Start (Col A) and End (Col W) timestamps from Archive
  // We pull A through W (1 to 23)
  const data = archiveSheet.getRange(2, 1, lastRow - 1, 23).getValues();

  // 2. Create an array of hours (0 to 23) to serve as our buckets
  const hours = Array.from({length: 24}, (_, i) => i);

  // 3. Extract hours from the timestamps using map and filter
  const startHours = data.map(row => row[0] instanceof Date ? row[0].getHours() : null).filter(h => h !== null);
  const endHours = data.map(row => row[22] instanceof Date ? row[22].getHours() : null).filter(h => h !== null);

  // 4. Process data into a 2D array [Hour, Start Count, End Count]
  const distributionResults = hours.map(hour => {
    const startCount = startHours.filter(h => h === hour).length;
    const endCount = endHours.filter(h => h === hour).length;
    
    // Format hour for readability (e.g., "9 AM", "2 PM")
    const ampm = hour >= 12 ? 'PM' : 'AM';
    const displayHour = hour % 12 || 12;
    const timeLabel = displayHour + " " + ampm;
    
    return [timeLabel, startCount, endCount];
  });

  // 5. Prepare output with header row
  const finalOutput = [
    ["Hour of Day", "Started Requests", "Ended Requests"], 
    ...distributionResults
  ];

  // 6. Clear previous data in Dashboard J:L to avoid ghosting
  const dashboardLastRow = dashboardSheet.getLastRow();
  if (dashboardLastRow >= 1) {
    dashboardSheet.getRange("J:L").clearContent();
  }

  // 7. Write the new data starting at J1
  dashboardSheet.getRange(1, 10, finalOutput.length, 3).setValues(finalOutput);
  
  // Optional: Apply formatting to header
  dashboardSheet.getRange("J1:L1").setFontWeight("bold");

  console.log("Dashboard distribution updated: " + (lastRow - 1) + " archive rows processed.");
}
